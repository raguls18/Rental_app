<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Property Details - RentHouse</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f5f5; color: #333; }
        
        .main-header { background: rgba(255, 255, 255, 0.98); box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1); position: sticky; top: 0; z-index: 1000; backdrop-filter: blur(10px); }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
        .header-content { display: flex; justify-content: space-between; align-items: center; padding: 20px 0; }
        .logo { font-size: 32px; font-weight: 700; color: #667eea; display: flex; align-items: center; gap: 12px; }
        .main-nav { display: flex; gap: 30px; align-items: center; }
        .main-nav a { text-decoration: none; color: #333; font-weight: 500; font-size: 16px; transition: all 0.3s ease; display: flex; align-items: center; gap: 8px; padding: 8px 16px; border-radius: 8px; }
        .main-nav a:hover { color: #667eea; background: rgba(102, 126, 234, 0.1); }
        .btn-logout { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white !important; padding: 10px 20px !important; border-radius: 25px; }
        .btn-logout:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); }
        
        main { padding: 40px 20px; }
        .back-btn { display: inline-flex; align-items: center; gap: 8px; color: #667eea; text-decoration: none; font-weight: 600; margin-bottom: 30px; transition: all 0.3s ease; }
        .back-btn:hover { gap: 12px; }
        
        .details-container { background: white; border-radius: 20px; overflow: hidden; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1); }
        
        .gallery-section { position: relative; }
        .main-image { width: 100%; height: 500px; background: #f0f0f0; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .main-image img { width: 100%; height: 100%; object-fit: cover; }
        
        .thumbnails { display: flex; gap: 10px; padding: 20px; background: #f9f9f9; overflow-x: auto; }
        .thumbnail { width: 100px; height: 100px; border-radius: 10px; cursor: pointer; overflow: hidden; border: 3px solid transparent; transition: all 0.3s ease; }
        .thumbnail img { width: 100%; height: 100%; object-fit: cover; }
        .thumbnail:hover, .thumbnail.active { border-color: #667eea; }
        
        .details-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 40px; padding: 40px; }
        
        .property-info h1 { font-size: 36px; margin-bottom: 15px; color: #333; }
        .price-display { font-size: 32px; font-weight: 700; color: #667eea; margin-bottom: 20px; }
        .location-info { display: flex; align-items: center; gap: 10px; color: #666; font-size: 16px; margin-bottom: 30px; }
        
        .features-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 30px; padding-bottom: 30px; border-bottom: 2px solid #f0f0f0; }
        .feature-box { display: flex; align-items: center; gap: 15px; }
        .feature-icon { width: 50px; height: 50px; background: rgba(102, 126, 234, 0.1); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: #667eea; font-size: 24px; }
        .feature-text h3 { font-size: 14px; color: #999; margin-bottom: 5px; }
        .feature-text p { font-size: 18px; font-weight: 600; color: #333; }
        
        .description-section { margin-bottom: 30px; }
        .description-section h3 { font-size: 20px; margin-bottom: 15px; color: #333; }
        .description-section p { line-height: 1.8; color: #666; }
        
        .amenities-section { margin-bottom: 30px; }
        .amenities-section h3 { font-size: 20px; margin-bottom: 15px; color: #333; }
        .amenities-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; }
        .amenity-item { display: flex; align-items: center; gap: 10px; padding: 12px; background: #f9f9f9; border-radius: 10px; }
        .amenity-item i { color: #667eea; font-size: 18px; }
        .amenity-item span { color: #666; }
        
        .sidebar { display: flex; flex-direction: column; gap: 20px; }
        .owner-card { background: #f9f9f9; border-radius: 15px; padding: 25px; text-align: center; }
        .owner-avatar { width: 80px; height: 80px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 40px; margin: 0 auto 15px; }
        .owner-name { font-size: 18px; font-weight: 700; color: #333; margin-bottom: 10px; }
        .owner-contact { color: #666; font-size: 14px; margin-bottom: 8px; word-break: break-all; }
        
        .action-buttons { display: flex; flex-direction: column; gap: 12px; }
        .btn { padding: 14px 20px; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 10px; font-size: 16px; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4); }
        .btn-secondary { background: #f0f0f0; color: #333; }
        .btn-secondary:hover { background: #e0e0e0; }
        .btn-favorite { background: white; color: #ff6b6b; border: 2px solid #ff6b6b; }
        .btn-favorite:hover { background: #ff6b6b; color: white; }
        .btn-favorite.active { background: #ff6b6b; color: white; }
        
        .share-menu { position: absolute; top: 100%; right: 0; background: white; border-radius: 10px; box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15); z-index: 100; min-width: 200px; overflow: hidden; display: none; }
        .share-menu.active { display: block; }
        .share-option { padding: 12px 16px; display: flex; align-items: center; gap: 12px; cursor: pointer; transition: all 0.2s ease; border: none; width: 100%; text-align: left; background: none; font-size: 14px; color: #333; }
        .share-option:hover { background: #f0f0f0; }
        .share-option i { color: #667eea; font-size: 18px; }
        
        .loading { text-align: center; padding: 60px 20px; }
        .loading i { font-size: 48px; color: #667eea; margin-bottom: 20px; display: block; animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        .error-message { background: #ff6b6b; color: white; padding: 20px; border-radius: 10px; text-align: center; margin: 40px 0; }
        
        .toast { position: fixed; bottom: 20px; right: 20px; background: #333; color: white; padding: 16px 24px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); z-index: 2000; animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        
        .share-btn-wrapper { position: relative; }
        
        @media (max-width: 768px) {
            .details-grid { grid-template-columns: 1fr; }
            .features-grid { grid-template-columns: 1fr; }
            .main-image { height: 300px; }
            .property-info h1 { font-size: 24px; }
            .price-display { font-size: 24px; }
            .share-menu { position: fixed; top: auto; bottom: 0; right: 0; left: 0; border-radius: 20px 20px 0 0; min-width: auto; }
        }
    </style>
</head>
<body>
    <header class="main-header">
        <div class="container">
            <div class="header-content">
                <h1 class="logo"><i class="fas fa-home"></i> RentHouse</h1>
                <nav class="main-nav">
                    <a href="seeker.html"><i class="fas fa-search"></i> Search</a>
                    <a href="favoritesseeker.html"><i class="fas fa-heart"></i> Favorites</a>
                    <a href="seeker-profile.html"><i class="fas fa-user-circle"></i> Profile</a>
                    <a href="#" id="nav-logout-btn" class="btn-logout"><i class="fas fa-sign-out-alt"></i> Logout</a>
                </nav>
            </div>
        </div>
    </header>

    <main class="container">
        <a href="javascript:history.back()" class="back-btn"><i class="fas fa-arrow-left"></i> Back</a>
        
        <div id="loading" class="loading">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Loading property details...</p>
        </div>

        <div id="error" class="error-message" style="display: none;"></div>

        <div id="details-container" class="details-container" style="display: none;">
            <div class="gallery-section">
                <div class="main-image">
                    <img id="main-image" src="/placeholder.svg" alt="Property">
                </div>
                <div class="thumbnails" id="thumbnails-container"></div>
            </div>

            <div class="details-grid">
                <div class="property-info">
                    <h1 id="property-title"></h1>
                    <div class="price-display" id="property-price"></div>
                    <div class="location-info">
                        <i class="fas fa-map-marker-alt"></i>
                        <span id="property-location"></span>
                    </div>

                    <div class="features-grid">
                        <div class="feature-box">
                            <div class="feature-icon"><i class="fas fa-bed"></i></div>
                            <div class="feature-text">
                                <h3>Bedrooms</h3>
                                <p id="property-bedrooms"></p>
                            </div>
                        </div>
                        <div class="feature-box">
                            <div class="feature-icon"><i class="fas fa-bath"></i></div>
                            <div class="feature-text">
                                <h3>Bathrooms</h3>
                                <p id="property-bathrooms"></p>
                            </div>
                        </div>
                        <div class="feature-box">
                            <div class="feature-icon"><i class="fas fa-ruler-combined"></i></div>
                            <div class="feature-text">
                                <h3>Area</h3>
                                <p id="property-area"></p>
                            </div>
                        </div>
                        <div class="feature-box">
                            <div class="feature-icon"><i class="fas fa-building"></i></div>
                            <div class="feature-text">
                                <h3>Type</h3>
                                <p id="property-type"></p>
                            </div>
                        </div>
                    </div>

                    <div class="description-section">
                        <h3>Description</h3>
                        <p id="property-description"></p>
                    </div>

                    <div class="amenities-section">
                        <h3>Amenities</h3>
                        <div class="amenities-grid" id="amenities-list"></div>
                    </div>
                </div>

                <div class="sidebar">
                    <div class="owner-card">
    <div class="owner-avatar" id="owner-avatar">
        <i class="fas fa-user-circle"></i> 
    </div>
    <p class="owner-name" id="owner-name">Property Owner</p>
    <p class="owner-contact"><i class="fas fa-phone"></i> <span id="owner-phone">Not provided</span></p>
    <p class="owner-contact"><i class="fas fa-envelope"></i> <span id="owner-email">Not provided</span></p>
</div>

                    <div class="action-buttons">
                        <button id="favorite-btn" class="btn btn-favorite">
                            <i class="far fa-heart"></i> Add to Favorites
                        </button>
                        <button id="contact-owner-btn" class="btn btn-primary">
                            <i class="fas fa-whatsapp"></i> Contact Owner
                        </button>
                        <div class="share-btn-wrapper">
                            <button id="share-property-btn" class="btn btn-secondary">
                                <i class="fas fa-share-alt"></i> Share Property
                            </button>
                            <div id="share-menu" class="share-menu">
                                <button class="share-option" id="share-whatsapp">
                                    <i class="fab fa-whatsapp"></i> WhatsApp
                                </button>
                                <button class="share-option" id="share-email">
                                    <i class="fas fa-envelope"></i> Email
                                </button>
                                <button class="share-option" id="share-copy">
                                    <i class="fas fa-link"></i> Copy Link
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script type="module">
        import { getPropertyByIds } from './js/firebase-properties.js';
        import { initializeAuth } from './js/firebase-auth.js';
        import { db } from './js/firebase-config.js';
        import { doc, getDoc } from "https://www.gstatic.com/firebasejs/10.3.1/firebase-firestore.js";

        let currentProperty = null;

        async function loadPropertyDetails() {
            try {
                await initializeAuth();
                
                const urlParams = new URLSearchParams(window.location.search);
                const propertyId = urlParams.get('id');

                if (!propertyId) {
                    showError('Property ID not found in URL');
                    return;
                }

                const result = await getPropertyByIds([propertyId]);
                
                if (!result.success || result.properties.length === 0) {
                    showError('Property not found');
                    return;
                }

                currentProperty = result.properties[0];
                
                // MODIFICATION: Fetch all owner details, including profile image
                if (currentProperty.ownerUid) {
                    const ownerData = await fetchOwnerData(currentProperty.ownerUid);
                    if (ownerData) {
                        currentProperty.ownerName = ownerData.fullname || 'Property Owner';
                        currentProperty.ownerPhone = ownerData.phone || 'Not provided';
                        currentProperty.ownerEmail = ownerData.email || 'Not provided';
                        // Add the profile image URL to the property object
                        currentProperty.ownerProfileImage = ownerData.profileImageUrl || null;
                    }
                }
                
                displayPropertyDetails(currentProperty);
                setupFavoriteButton(propertyId);
                setupContactOwnerButton(currentProperty);
                setupSharePropertyButton(currentProperty);
                setupLogoutButton();
            } catch (error) {
                console.error('Error loading property:', error);
                showError('Failed to load property details');
            }
        }

        async function fetchOwnerData(ownerUid) {
            try {
                const userDoc = await getDoc(doc(db, 'users', ownerUid));
                if (userDoc.exists()) {
                    return userDoc.data();
                }
                return null;
            } catch (error) {
                console.error('Error fetching owner data:', error);
                return null;
            }
        }

        // MODIFICATION: Entire function updated to handle all owner data
 function displayPropertyDetails(property) {
    document.getElementById('loading').style.display = 'none';
    document.getElementById('details-container').style.display = 'block';

    // Set basic info
    document.getElementById('property-title').textContent = property.type ?? 'Property';
    document.getElementById('property-price').textContent = `₹${property.rent?.toLocaleString() ?? 'N/A'}/month`;
    document.getElementById('property-location').textContent = `${property.address ?? ''}, ${property.city ?? ''}`;
    
    // Set features
    document.getElementById('property-bedrooms').textContent = property.bedrooms ?? 'N/A';
    document.getElementById('property-bathrooms').textContent = property.bathrooms ?? 'N/A';
    document.getElementById('property-area').textContent = `${property.area ?? 'N/A'} sqft`;
    document.getElementById('property-type').textContent = property.type ?? 'N/A';
    
    // Set description
    document.getElementById('property-description').textContent = property.description ?? 'No description available';
    
    // Set amenities
    const amenitiesList = document.getElementById('amenities-list');
    const amenities = property.amenities ?? [];
    if (amenities.length > 0) {
        amenitiesList.innerHTML = amenities.map(amenity => `
            <div class="amenity-item">
                <i class="fas fa-check-circle"></i>
                <span>${amenity}</span>
            </div>
        `).join('');
    } else {
        amenitiesList.innerHTML = '<p>No amenities listed</p>';
    }
    
    // --- NEW AND IMPROVED OWNER SECTION ---
    const ownerAvatarContainer = document.getElementById('owner-avatar');
    
    // Use the full owner data we fetched
    document.getElementById('owner-name').textContent = property.ownerName ?? 'Property Owner';
    document.getElementById('owner-phone').textContent = property.ownerPhone ?? 'Not provided';
    document.getElementById('owner-email').textContent = property.ownerEmail ?? 'Not provided';

    // Check for a profile image URL and display it
    if (property.ownerProfileImage) {
        ownerAvatarContainer.innerHTML = `<img src="${property.ownerProfileImage}" alt="${property.ownerName}" style="width:100%; height:100%; border-radius:50%; object-fit:cover;">`;
    } else {
        // If no image, keep the default icon
        ownerAvatarContainer.innerHTML = `<i class="fas fa-user-circle"></i>`;
    }
    
    // Set images
    const mainImage = document.getElementById('main-image');
    const thumbnailsContainer = document.getElementById('thumbnails-container');
    
    const images = property.images ?? ['/placeholder.svg?height=500&width=800'];
    mainImage.src = images[0] || '/placeholder.svg?height=500&width=800';
    
    thumbnailsContainer.innerHTML = images.map((img, index) => `
        <div class="thumbnail ${index === 0 ? 'active' : ''}" onclick="changeMainImage('${img}', this)">
            <img src="${img}" alt="Property image ${index + 1}">
        </div>
    `).join('');
}
        function setupFavoriteButton(propertyId) {
            const favoriteBtn = document.getElementById('favorite-btn');
            let favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
            
            if (favorites.includes(propertyId)) {
                favoriteBtn.classList.add('active');
                favoriteBtn.innerHTML = '<i class="fas fa-heart"></i> Remove from Favorites';
            }
            
            favoriteBtn.addEventListener('click', () => {
                // Re-fetch favorites from storage in case it was changed in another tab
                favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
                const index = favorites.indexOf(propertyId);
                if (index > -1) {
                    favorites.splice(index, 1);
                    favoriteBtn.classList.remove('active');
                    favoriteBtn.innerHTML = '<i class="far fa-heart"></i> Add to Favorites';
                } else {
                    favorites.push(propertyId);
                    favoriteBtn.classList.add('active');
                    favoriteBtn.innerHTML = '<i class="fas fa-heart"></i> Remove from Favorites';
                }
                localStorage.setItem('favorites', JSON.stringify(favorites));
            });
        }

        function setupContactOwnerButton(property) {
            const contactBtn = document.getElementById('contact-owner-btn');
            contactBtn.addEventListener('click', () => {
                const phone = property.ownerPhone;
                if (!phone || phone === 'Not provided') {
                    showToast('Owner phone number not available');
                    return;
                }
                const formattedPhone = phone.replace(/\D/g, '');
                const message = `Hi, I'm interested in your property: ${property.type} at ${property.address}, ${property.city}. Rent: ₹${property.rent}/month. Can you provide more details?`;
                const whatsappUrl = `https://wa.me/${formattedPhone}?text=${encodeURIComponent(message)}`;
                window.open(whatsappUrl, '_blank');
            });
        }

        function setupSharePropertyButton(property) {
            const shareBtn = document.getElementById('share-property-btn');
            const shareMenu = document.getElementById('share-menu');
            const propertyUrl = window.location.href;
            const propertyTitle = `${property.type} - ₹${property.rent}/month`;

            shareBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                shareMenu.classList.toggle('active');
            });

            document.addEventListener('click', (e) => {
                if (!e.target.closest('.share-btn-wrapper')) {
                    shareMenu.classList.remove('active');
                }
            });

            document.getElementById('share-whatsapp').addEventListener('click', () => {
                const message = `Check out this property: ${propertyTitle}\n${propertyUrl}`;
                const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
                window.open(whatsappUrl, '_blank');
                shareMenu.classList.remove('active');
            });

            document.getElementById('share-email').addEventListener('click', () => {
                const subject = `Check out this property: ${propertyTitle}`;
                const body = `I found this property on RentHouse:\n\n${propertyTitle}\n${property.address}, ${property.city}\n\nView details: ${propertyUrl}`;
                const mailtoUrl = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                window.location.href = mailtoUrl;
                shareMenu.classList.remove('active');
            });

            document.getElementById('share-copy').addEventListener('click', () => {
                navigator.clipboard.writeText(propertyUrl).then(() => {
                    showToast('Link copied to clipboard!');
                    shareMenu.classList.remove('active');
                }).catch(() => {
                    showToast('Failed to copy link');
                });
            });
        }

        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        function setupLogoutButton() {
            const logoutBtn = document.getElementById('nav-logout-btn');
            logoutBtn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                if (confirm('Are you sure you want to logout?')) {
                    localStorage.removeItem('user');
                    window.location.href = 'login.html';
                }
            });
        }

        function showError(message) {
            document.getElementById('loading').style.display = 'none';
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        window.changeMainImage = function(src, element) {
            document.getElementById('main-image').src = src;
            document.querySelectorAll('.thumbnail').forEach(t => t.classList.remove('active'));
            element.classList.add('active');
        };

        loadPropertyDetails();
    </script>

    <script type="module" src="js/property-details.js"></script>
</body>
</html>